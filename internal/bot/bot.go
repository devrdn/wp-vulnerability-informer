package bot

import (
	"errors"
	"fmt"

	"github.com/devrdn/wp-vulnerability-informer/internal/config"
	"github.com/devrdn/wp-vulnerability-informer/internal/models"
	tele "gopkg.in/telebot.v3"
	"gopkg.in/telebot.v3/layout"
	"gopkg.in/telebot.v3/middleware"
)

type Bot struct {
	*tele.Bot
	owner   tele.ChatID
	channel tele.ChatID
}

var (
	ErrFailedParseLayout = errors.New("bot: failed to parse bot layout")
	ErrFailedCreateBot   = errors.New("bot: failed to create new bot")
	ErrSendOwner         = errors.New("bot: error when sending a message to the owner")
)

const (
	BotStartedMessage   = "ðŸŸ¢ bot: successfully started"
	ErrorSendingMessage = "ðŸ›‘ bot: error when sending a message to the channel"
)

// New creates a new Bot instance
func New(cfg config.BotConfig) (*Bot, error) {
	lt, err := layout.New(cfg.BotConfigPath)
	if err != nil {
		return nil, ErrFailedParseLayout
	}

	b, err := tele.NewBot(lt.Settings())
	if err != nil {
		return nil, ErrFailedCreateBot
	}

	return &Bot{
		Bot:     b,
		owner:   tele.ChatID(cfg.OwnerId),
		channel: tele.ChatID(cfg.ChannelId),
	}, nil
}

// Run initiates the execution of the Bot.
// It sets up command handlers for various commands
func (b *Bot) Run() {
	b.Use(middleware.Whitelist(int64(b.owner)))

	b.Handle("/ping", b.OnPing)

	b.Send(b.owner, BotStartedMessage, tele.Silent)

	b.Start()
}

// SendToChannel method sends information of new vulnerabilities
// to telegram bot channel
func (b *Bot) SendToChannel(vulnerability models.Vulnerability) {
	_, err := b.Send(
		b.channel,
		vulnerability.String(),
		tele.NoPreview,
	)
	if err != nil {
		b.SendToOwner(fmt.Sprintf("%s: %s", ErrorSendingMessage, err))
		return
	}
}

// SendToOwner method sends message to Bot owner
func (b *Bot) SendToOwner(text string, opts ...interface{}) {
	_, err := b.Send(b.owner, text, opts...)
	if err != nil {
		b.OnError(ErrSendOwner, nil)
	}
}
