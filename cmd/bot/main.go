package main

import (
	"database/sql"
	"flag"
	"log"
	"time"

	"github.com/devrdn/wp-vulnerability-informer/internal/models"
	"github.com/devrdn/wp-vulnerability-informer/internal/parser"
	_ "github.com/joho/godotenv/autoload"
	_ "github.com/mattn/go-sqlite3"
)

const (
	targetHour     = 00
	targetMinute   = 29
	defaultBaseURL = "https://www.wordfence.com/threat-intel/vulnerabilities?page="
)

type Config struct {
	paginationLimit int
	baseUrl         string
	Bot             struct {
		owner   int
		channel int
	}
}

func main() {
	var cfg Config

	// parse flags
	flag.IntVar(&cfg.paginationLimit, "pagination-limit", 2, "Pagination Limit")
	flag.StringVar(&cfg.baseUrl, "base-url", defaultBaseURL, "BaseUrl")
	flag.IntVar(&cfg.Bot.channel, "channel-id", -1001842465106, "Channel Id")
	flag.IntVar(&cfg.Bot.owner, "owner-id", 464058962, "Owner Id")
	flag.Parse()

	// create new parser
	prs := parser.New(cfg.paginationLimit, cfg.baseUrl)

	// connect to db
	db, err := sql.Open("sqlite3", "sqlite3.db")
	if err != nil {
		log.Fatal(err)
	}

	vulnerabilityModel := models.NewVulnerability(db)

	b, err := NewBot("config/bot/bot.yml", cfg.Bot.owner, cfg.Bot.channel)
	if err != nil {
		log.Fatal(err)
	}

	go b.Run()

	for {
		// process vulnerabilities and send data to bot
		err := processData(prs, b, vulnerabilityModel)
		if err != nil {
			log.Println(err)
		}

		now := time.Now()
		next := now.Add(time.Hour * 24)
		next = time.Date(next.Year(), next.Month(), next.Day(), targetHour, targetMinute, 0, 0, next.Location())

		time.Sleep(next.Sub(now))
	}

}
